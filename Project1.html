<html>
	<head>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<title>Civil Wars and GDP</title>
		<style>
			
			.axis path,
			.axis line{
				fill: none;
				stroke: black;
			}

			.line{
				fill: none;
				stroke: blue;
				stroke-width: 5px;
			}

			.tick text{
				font-size: 12px;
			}	
			.tick line{
				opacity: 0.2;
			}

		</style>
	</head>

	<body>
		<div id = "linePlot"></div>
		<br><br><br><br><br><br><br>
		<div id = "map"></div>

		<script>
			//Needed for intensity average
			function avg(l){
				var sum = 0;
				for(var i=0;i<l.length;i++){
					sum+=l[i];
				}
				return sum/l.length;
			}
			//function taken from http://www.endmemo.com/js/arrcontains.php
			Array.prototype.contains = function(elem){
				for (var i in this){
					if (this[i] == elem) return true;
				}
				return false;
			};

			//Svg initializations
			var height = 800;
			var width = 1300;
			padding = 70;
			var svg = d3.select("#linePlot").append("svg").attr("width",width)
				.attr("height",height);
				
			//20px margin
			var g = svg.append("g");

			//Create our line graph scale and axes
			var xScale = d3.scale.linear().domain([1960,2014]).range([padding,width-padding]);
			var yScale = d3.scale.linear().domain([0, 4300]).range([height-padding,padding]);

			var xAxis = d3.svg.axis().scale(xScale).orient("bottom").innerTickSize(-height +2*padding).outerTickSize(0).tickPadding(10).tickFormat(d3.format('f%'));
			var yAxis = d3.svg.axis().scale(yScale).orient("left").innerTickSize(-width+ 2*padding).outerTickSize(0).tickPadding(10);

			svg.append("rect")
				.attr("x",padding)
				.attr("y",padding)
				.attr("width",width-(2*padding))
				.attr("height",height - (2*padding))
				.attr("fill","#d9d9d9");

			svg.append("g").attr("class", "axis")
				.attr("transform", "translate(0," + (height-padding) + ")").call(xAxis);

			svg.append("g").attr("class","axis")
				.attr("transform","translate(" + padding + ",0)").call(yAxis);


			//Create a line function for gdp over time
			var lineFunction = d3.svg.line().x(function(d){
				return xScale(d.x);
			})
			.y(function(d){
				return yScale(d.y);
			})
			.interpolate("linear");

			//Color scale
			var colorGradient = d3.scale.linear().domain([1,7]).range(["blue","red"]);

			//Let's look at our data and make some graphs!
			d3.json("realCleanWars.json",function(error, json){
				civData = json;
				var whatWeHave = [];
				if(error){ console.log(error);}

				//Initializations for data manipulation
				var prevCode = civData[0].Code;
				var prevYear = (civData[0].Year) - 1;
				var start = civData[0].Year;
				var countryObjects = [];
				var avgTemp = [];
				var repeats = [];
				var gdp = [];
				var gdpTemp = [];
				var yearsTemp = [];

				civData.forEach(function(country){
					whatWeHave.push(country.Code);

					//Checks to see if we've moved on to a new country
					if((country.Code != prevCode) || Math.abs(country.Year-prevYear) > 1) {

						//Edge case in case there's another a country with multiple wars only take one
						if( (prevName in repeats && avg(avgTemp) > countryObjects[repeats.indexOf(prevName)].Intensity) ){
							countryObjects[repeats.indexOf(prevName)].Intensity = avg(avgTemp);

						}else if(!(repeats.contains(prevName))){ //Add country object
							repeats.push(prevName);
							countryObjects.push({Name:prevName, Intensity: avg(avgTemp), Years: yearsTemp, GDP: gdpTemp, Code: prevCode});
						}

						avgTemp = [];
						gdpTemp = [];
						start = country.Year;
						yearsTemp = [];

					}

					avgTemp.push(country.Intensity);

					//Only want countries with GDP data
					if(country.GDP != 0){
						yearsTemp.push(country.Year)
						gdpTemp.push(country.GDP);
					}

					prevName = country.Country;
					prevYear = country.Year;
					prevCode = country.Code;
					
				});
				
				//Edge case
				countryObjects[repeats.indexOf('Afghanistan')].GDP.pop();
				countryObjects[repeats.indexOf('Afghanistan')].Years.pop();
				countryObjects[repeats.indexOf('Laos')].GDP = [];

				//Creates our line graph
				drawDemLines(countryObjects);
				
				//Initialize map svg
				var mapHeight = 500;
				var mapWidth = 960;

				var projection = d3.geo.equirectangular()
					.center([28,50])
				    .scale(450)
				    .translate([0,0])
				    .precision(.1);

				var path = d3.geo.path().projection(projection);

				var mapsvg = d3.select("#map").append("svg").attr("height",mapHeight)
					.attr("width",mapWidth);
				var mapg = mapsvg.append("g");

				d3.json("world-50m.json", function(error, world) {
					worldObjects = world;

					var countries = topojson.feature(world, world.objects.countries).features;
		
					// convert each country's data into a path element.
					countries.forEach(function (country) {
						
						if(whatWeHave.contains(country.id)){
							cInt = findIntensity(countryObjects,country.id);
							mapg.append("path").attr("d", path(country))
							.style("fill", "#ddffdd")
							.style("stroke", "#222");

							var pirate = path(country).split(",");
							pirate[0] = pirate[0].substring(1,pirate[0].length)
							temp = pirate[1].split("L");
							mapg.append("circle")
							.attr("cx",pirate[0])
							.attr("cy",temp[0])
							.attr("r",cInt*2)
							.style("fill","red");
							//console.log(path(country));
						}
						else{
							mapg.append("path").attr("d", path(country))
							.style("fill", "#ccc")
							.style("stroke", "#888");
						}
						
					});
				});

			});

			function findIntensity(arr,id){
				for(var i=0;i<arr.length;i++){
					if(arr[i].Code == id)
						return arr[i].Intensity;

				}
				return -1;
			}

   			function drawDemLines(intensity){
	   			gdpCoords = [];

	   			intensity.forEach(function(country){
	   				gdpCoords = []
	   				for(var i = 0; i<country.GDP.length; i++){
	   					gdpCoords.push({x:country.Years[i] , y: country.GDP[i]});
	   				}
	   				
	   				svg.append("path")
						.attr("d", lineFunction(gdpCoords))
						.attr("stroke", colorGradient(country.Intensity))
						.attr("stroke-width",3)
						.attr("fill", "none")
						.attr("class",country.Name);
					console.log(country.Name);
	   			})

	   			//Labels and corresponding locations
	   			xText = [1966,1979,1980.5,1979,1986.5, 1985.5,1992.25,1993,2001,1975,1965.25];
	   			yText = [210,320,1400,2500,480,100,800,320,300, 120,50];
	   			countries = ["Thailand","Afghanistan","Syria","Iran","Sri Lanka","Yemen","Georgia","Tajikistan","Nepal","Cambodia","North Vietnam",]

	   			for(var i = 0; i<xText.length; i++){
	   				svg.append("text")
	   				.attr("x", xScale(xText[i]))
	   				.attr("y", yScale(yText[i]))
	   				.text(countries[i])
	   			}

			};
			
		</script>
	</body>
</html>

